"use strict";angular.module("meteoApp",["ngResource","ngRoute","owmServices","ngLadda"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/details",{templateUrl:"views/details.html",controller:"DetailsCtrl"}).otherwise({redirectTo:"/"})}]).run(["$cacheFactory",function(a){a("meteoCache")}]);var showNotifCallback=function(a,b){new b("Il va geler !",{body:"Il est prévu "+a+"° cette nuit."})};angular.module("meteoApp").controller("MainCtrl",["$scope","$rootScope","DailyForecast","$window","$cacheFactory",function(a,b,c,d,e){b.jourLoading=1;var f=function(f){var g={};return"undefined"!=typeof f&&(g={q:f}),c.query(g,function(c){var f=c[0].temp.night;if(parseFloat(f)<5)if("Notification"in d){var g=d.Notification.permission;"default"===g?d.Notification.requestPermission(function(a){"granted"===a&&showNotifCallback(f,d.Notification)}):"granted"===g&&showNotifCallback(f,d.Notification)}else console.log("No notification API support.");b.jourLoading=0;var h=e.get("meteoCache");a.weatherTown=h.get("weatherTown")},function(c){a.errorMsg=c,b.jourLoading=0})};a.dailyForecast=f(),b.$on("doSearch",function(c,d){b.jourLoading=1,a.dailyForecast=f(d)})}]).controller("DetailsCtrl",["$scope","$rootScope","Forecast","$cacheFactory",function(a,b,c,d){b.heureLoading=1,a.forecast=c.query({},function(){b.heureLoading=0;var c=d.get("meteoCache");a.weatherTown=c.get("weatherTown")},function(c){a.errorMsg=c,b.heureLoading=0})}]).controller("MenuCtrl",["$scope","$rootScope",function(a,b){a.$on("$routeChangeSuccess",function(b,c){var d=c.$$route.controller;"MainCtrl"===d?a.activeTab="jour":"DetailsCtrl"===d&&(a.activeTab="heure")}),a.doSearch=function(){"undefined"!=typeof a.town&&b.$emit("doSearch",a.town)}}]);var endpoint="http://api.openweathermap.org/data/2.5/forecast",doTransformResponse=function(a,b){var c=JSON.parse(a),d=b.get("meteoCache");d.put("weatherTown",c.city);var e=c.list;return angular.forEach(e,function(a){a.dt=1e3*parseInt(a.dt,10)}),e};angular.module("owmServices",[]).factory("DailyForecast",["$resource","$cacheFactory",function(a,b){return a(endpoint+"/daily",{mode:"json",units:"metric",q:"Poissy",cnt:"14"},{query:{method:"GET",isArray:!0,transformResponse:function(a){return doTransformResponse(a,b)},cache:!0}})}]).factory("Forecast",["$resource","$cacheFactory",function(a,b){return a(endpoint,{mode:"json",units:"metric",q:"Poissy"},{query:{method:"GET",isArray:!0,transformResponse:function(a){return doTransformResponse(a,b)},cache:!0}})}]);